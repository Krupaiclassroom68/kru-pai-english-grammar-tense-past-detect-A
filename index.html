<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Past Simple ‚Ä¢ Sentence Detective (Infinite Amber)</title>
  <style>
    :root{
      --bg1:#050612;
      --bg2:#0a0c1e;
      --card: rgba(255,255,255,.07);
      --stroke: rgba(102,224,255,.22);   /* neon cyan */
      --stroke2: rgba(178,110,255,.45);  /* neon purple */
      --text: rgba(255,255,255,.96);
      --muted: rgba(210,230,255,.78);
      --good: #66e0ff;   /* cyan */
      --bad: #ff4d8a;    /* neon pink */
      --shadow: 0 22px 70px rgba(0,0,0,.78);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif;
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1100px 720px at 18% 10%, rgba(102,224,255,.18), transparent 60%),
        radial-gradient(950px 620px at 88% 15%, rgba(178,110,255,.16), transparent 55%),
        radial-gradient(900px 700px at 52% 110%, rgba(255,77,138,.10), transparent 60%),
        linear-gradient(145deg, var(--bg1), var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{width:min(980px, 100%);}
    .brand{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin:6px 4px 14px;
    }
    .brand h1{
      margin:0;
      font-size: clamp(18px, 2.4vw, 28px);
      letter-spacing:.2px;
      text-shadow:0 2px 10px rgba(0,0,0,.45);
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      background:rgba(102,224,255,.07);
      border:1px solid rgba(102,224,255,.26);
      border-radius:999px;
      font-weight:900;
      color:rgba(255,255,255,.92);
      box-shadow:0 10px 26px rgba(0,0,0,.28);
      user-select:none;
      white-space:nowrap;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .top{
      padding:16px 16px 12px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.05));
      border-bottom:1px solid var(--stroke);
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .stats{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .stat{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:16px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
      font-weight:1000;
      letter-spacing:.2px;
      text-shadow:0 1px 4px rgba(0,0,0,.6);
      min-width: 118px;
      justify-content:center;
    }
    .stat b{font-size: 18px;}
    .timer{
      display:none;
      padding:10px 12px;
      border-radius:16px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
      font-weight:1100;
      letter-spacing:.2px;
      min-width: 140px;
      justify-content:center;
      text-shadow:0 1px 4px rgba(0,0,0,.6);
    }
    .timer.show{display:flex}
    .timer .t{font-size:18px; margin-left:8px;}
    .modeTag{
      padding:10px 12px;
      border-radius:16px;
      background:rgba(102,224,255,.07);
      border:1px solid rgba(102,224,255,.28);
      font-weight:1000;
      letter-spacing:.2px;
      user-select:none;
      box-shadow:0 10px 26px rgba(0,0,0,.22);
    }
    .main{padding:16px;}
    .screen{display:none;}
    .screen.active{display:block;}
    .hero{padding:22px 18px; text-align:center;}
    .hero h2{
      margin:6px 0 10px;
      font-size: clamp(22px, 3.0vw, 38px);
      font-weight:1200;
      letter-spacing:.2px;
      text-shadow:0 2px 14px rgba(0,0,0,.55);
    }
    .hero p{
      margin:0 auto;
      max-width: 760px;
      color:var(--muted);
      font-weight:800;
      line-height:1.55;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:14px;}
    input[type="text"]{
      width:min(420px, 100%);
      padding:14px 14px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.08);
      color:var(--text);
      outline:none;
      font-weight:1000;
      font-size:16px;
      box-shadow:0 10px 24px rgba(0,0,0,.18);
    }
    .btn{
      border:none;
      padding:18px 24px;
      font-size:20px;
      font-weight:1400;
      letter-spacing:.7px;
      border-radius:22px;
      border:2px solid rgba(178,110,255,.45);
      background: rgba(255,255,255,.12);
      color:#fff;
      box-shadow: 0 0 0 1px rgba(102,224,255,.22), 0 18px 50px rgba(0,0,0,.65);
      cursor:pointer;
      user-select:none;
      text-shadow:0 1px 3px rgba(0,0,0,.6);
      transition: transform .1s ease, box-shadow .2s ease, filter .2s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 0 26px rgba(102,224,255,.35), 0 24px 70px rgba(0,0,0,.75);
      background:rgba(255,255,255,.16);
    }
    .btn:active{transform: translateY(0px) scale(.99);}
    .btn.primary{
      background: linear-gradient(90deg, rgba(102,224,255,.95), rgba(178,110,255,.85), rgba(102,224,255,.95));
      background-size: 200% 200%;
      animation: neonShift 2.2s linear infinite;
      border:2px solid rgba(102,224,255,.85);
      color:#07070a;
      text-shadow:none;
    }
    .btn.danger{
      background:linear-gradient(180deg, rgba(255,77,109,.35), rgba(255,77,109,.14));
      border-color: rgba(255,77,109,.75);
    }
    .btn.ghost{background:rgba(255,255,255,.10);}
    .btn.block{width:min(520px, 100%); padding:18px 24px;}
    .questionHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      padding:14px 14px 10px;
      background:rgba(0,0,0,.18);
      border:1px solid var(--stroke);
      border-radius:18px;
      margin-bottom:12px;
    }
    .qleft{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,196,90,.08);
      border:1px solid rgba(102,224,255,.28);
      font-weight:1100;
      user-select:none;
    }
    .badge.deep{border-color:rgba(255,77,109,.45); background:rgba(255,77,109,.10);}
    .badge.small{font-size:13px; font-weight:1000; color:rgba(255,255,255,.92);}
    /* sentence area */
    .sentenceBox{
      position:relative;
      border-radius:18px;
      border:1px solid rgba(102,224,255,.28);
      background:rgba(0,0,0,.22);
      overflow:hidden;
      isolation:isolate; /* safe stacking */
    }
    /* wave layer as separate div (never blocks clicks) */
    .wave{
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 30% 40%, rgba(102,224,255,.16), transparent 55%),
        radial-gradient(circle at 75% 55%, rgba(255,77,138,.12), transparent 58%),
        radial-gradient(circle at 55% 30%, rgba(255,255,255,.06), transparent 60%);
      mix-blend-mode: screen;
      pointer-events:none;
      animation: waveDrift 12s ease-in-out infinite;
      z-index:0;
    }
    .scan{
      position:absolute; inset:0;
      background: linear-gradient(180deg, transparent 0%, rgba(102,224,255,.18) 46%, rgba(255,255,255,.05) 50%, rgba(102,224,255,.14) 54%, transparent 100%);
      pointer-events:none;
      opacity:0;
      animation: scanLine 7.8s ease-in-out infinite;
      z-index:1;
    }
    @keyframes waveDrift{
      0%{transform: translate3d(0,0,0) scale(1.02); opacity:.18;}
      50%{transform: translate3d(-10px,6px,0) scale(1.05); opacity:.26;}
      100%{transform: translate3d(0,0,0) scale(1.02); opacity:.18;}
    }
    @keyframes neonShift{
      0%{background-position:0% 50%;}
      100%{background-position:100% 50%;}
    }
    @keyframes scanLine{
      0%{transform: translateY(-140%); opacity:0;}
      12%{opacity:.18;}
      50%{opacity:.12;}
      88%{opacity:.18;}
      100%{transform: translateY(140%); opacity:0;}
    }
    .sentenceInner{
      position:relative;
      z-index:2;
      padding:18px 14px;
    }
    .sentence{
      font-size: clamp(26px, 4vw, 38px);
      font-weight:1400;
      line-height:1.45;
      letter-spacing:.35px;
      color:rgba(255,255,255,.98);
      text-shadow: 0 0 14px rgba(102,224,255,.18), 0 2px 8px rgba(0,0,0,.65);
      user-select:none;
      text-align:center;
    }
    .word{
      display:inline-block;
      padding:6px 10px;
      margin:4px 3px;
      border-radius:14px;
      border:1px solid transparent;
      cursor:default;
      user-select:none;
      font-weight:1200;
      color:rgba(255,255,255,.98);
      background:rgba(255,255,255,.08);
      text-shadow:0 1px 4px rgba(0,0,0,.55);
      transition: transform .08s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
      pointer-events:auto;
      touch-action:manipulation;
    }
    .word.selectable{
      cursor:pointer;
      background:rgba(255,255,255,.16);
      border-color:rgba(255,255,255,.45);
    }
    .word.selectable:hover{transform: translateY(-1px);}
    .word.hl{
      border-color: rgba(255,196,90,.95);
      background: rgba(102,224,255,.14);
      box-shadow: 0 10px 24px rgba(255,196,90,.12);
    }
    .controls{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:12px;}
    #btnCorrect, #btnIncorrect{min-width: 240px;}
    .msg{
      margin-top:12px;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(0,0,0,.38);
      font-weight:1150;
      color:rgba(255,255,255,.98);
      min-height:52px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    /* Popups */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:5000;
    }
    .backdrop.show{display:flex;}
    .popup{
      width:min(640px, 100%);
      background: linear-gradient(180deg, rgba(18,22,29,.98), rgba(8,10,14,.98));
      border:2px solid rgba(102,224,255,.22);
      border-radius:22px;
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
      overflow:hidden;
      pointer-events:auto;
    }
    .popupTop{
      padding:14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .popupTop .title{font-weight:1200;}
    .popupBody{padding:14px;}
    .choices{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width:720px){ .choices{grid-template-columns: 1fr 1fr;} }
    .choice{
      padding:14px 12px;
      border-radius:18px;
      border:2px solid rgba(102,224,255,.22);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.96);
      font-weight:1200;
      text-align:center;
      cursor:pointer;
      user-select:none;
      pointer-events:auto;
      touch-action:manipulation;
    }
    .choice:hover{background:rgba(255,255,255,.06); border-color:rgba(178,110,255,.45); transform: translateY(-1px);}
    .smallNote{color:var(--muted); font-weight:800; text-align:center; margin-top:10px;}
    .review{margin-top:14px; padding:12px; border-radius:18px; border:1px solid rgba(255,255,255,.18); background:rgba(0,0,0,.20); overflow:auto;}
    table{width:100%; border-collapse:collapse; min-width:760px;}
    th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.12); vertical-align:top;}
    th{font-weight:1200; text-align:left; color:rgba(255,255,255,.92); background:rgba(255,255,255,.05); position:sticky; top:0;}
    td{color:rgba(255,255,255,.86); font-weight:800;}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-weight:1100; border:1px solid rgba(255,255,255,.18); background:rgba(0,0,0,.20); white-space:nowrap;}
    .pill.ok{border-color:rgba(90,255,190,.35); background:rgba(90,255,190,.10);}
    .pill.no{border-color:rgba(255,77,109,.35); background:rgba(255,77,109,.10);}
    .pill.mid{border-color:rgba(102,224,255,.35); background:rgba(255,196,90,.10);}
    .footerBtns{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:14px;}
    @media (prefers-reduced-motion: reduce){
      .wave, .scan{animation:none !important;}
    }
  
    /* ===== WOW PACK: Confetti + Emoji + Win Banner ===== */
    #confetti{
      position:fixed; inset:0; width:100vw; height:100vh;
      pointer-events:none; z-index:999;
    }
    #emojiBurst{
      position:fixed; inset:0; pointer-events:none; z-index:1000;
    }
    .emojiPop{
      position:absolute;
      font-size: 64px;
      transform: translate(-50%, -50%) scale(.6);
      opacity:0;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.5));
      animation: pop 780ms ease-out forwards;
    }
    @keyframes pop{
      0%{opacity:0; transform:translate(-50%,-50%) scale(.6);}
      22%{opacity:1; transform:translate(-50%,-50%) scale(1.12);}
      100%{opacity:0; transform:translate(-50%,-92%) scale(.92);}
    }

    .winBanner{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:12px 16px;
      border-radius:999px;
      border:2px solid rgba(102,224,255,.55);
      background: linear-gradient(180deg, rgba(102,224,255,.22), rgba(0,0,0,.22));
      box-shadow: 0 0 32px rgba(102,224,255,.20), 0 22px 70px rgba(0,0,0,.75);
      font-weight:1200;
      letter-spacing:.5px;
      margin: 10px auto 0;
      width: fit-content;
      animation: winPulse 1.4s ease-in-out infinite;
    }
    @keyframes winPulse{
      0%,100%{ transform: scale(1); filter: drop-shadow(0 0 0 rgba(255,196,90,0)); }
      50%{ transform: scale(1.03); filter: drop-shadow(0 0 18px rgba(102,224,255,.28)); }
    }

    /* Big score card on end screen */
    .scoreBig{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
    }
    .scoreBig .stat{
      min-width: 180px;
      padding:14px 16px;
    }
    .scoreBig .stat b{
      font-size: 26px;
    }

  
    /* ===== CENTER MEGA EMOJI BLAST ===== */
    .emojiMega{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%) scale(.5);
      font-size:120px;
      opacity:0;
      animation: mega 1.2s ease-out forwards;
      filter: drop-shadow(0 20px 40px rgba(0,0,0,.6));
    }
    @keyframes mega{
      0%{opacity:0; transform:translate(-50%,-50%) scale(.4);}
      20%{opacity:1; transform:translate(-50%,-50%) scale(1.2);}
      60%{opacity:1; transform:translate(-50%,-50%) scale(1);}
      100%{opacity:0; transform:translate(-50%,-80%) scale(.9);}
    }


    /* ===== RIBBON CONFETTI ===== */
    .ribbon{
      position:absolute;
      width:14px;
      height:40px;
      border-radius:6px;
      opacity:.9;
      animation: ribbonFall 1.4s linear forwards;
    }
    @keyframes ribbonFall{
      0%{ transform: translateY(-40px) rotate(0deg); opacity:1; }
      100%{ transform: translateY(120vh) rotate(540deg); opacity:0; }
    }


    #ribbonLayer{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:1200;
    }
    .ribbon{
      position:absolute;
      top:-60px;
      width:16px;
      height:48px;
      border-radius:6px;
      opacity:.95;
      animation: ribbonFall 1.6s linear forwards;
    }
    @keyframes ribbonFall{
      0%{ transform: translateY(0) rotate(0deg); opacity:1; }
      100%{ transform: translateY(120vh) rotate(720deg); opacity:0; }
    }

</style>
</head>
<body>
<div id='ribbonLayer'></div>

  <canvas id="confetti"></canvas>
  <div id="emojiBurst" aria-hidden="true"></div>

  <div class="wrap">
    <div class="brand">
      <h1>Past Simple ‚Ä¢ Sentence Detective <span style="opacity:.85">(Premium 25)</span></h1>
      <div class="chip">üéÆ Neon Gaming ‚Ä¢ Past Tense Mission</div>
    </div>

    <div class="card">
      <div class="top">
        <div class="stats">
          <div class="stat">‚úÖ + <b id="posScore">0</b></div>
          <div class="stat">‚ö†Ô∏è ‚àí <b id="negScore">0</b></div>
          <div class="stat">‚≠ê Net <b id="netScore">0</b></div>
          <div class="timer" id="timerBox">‚è≥ Time <span class="t" id="timeLeft">20</span>s</div>
        </div>
        <div class="modeTag" id="modeTag">Mode: ‚Äî</div>
      </div>

      <div class="main">
        <!-- START -->
        <section class="screen active" id="startScreen">
          <div class="hero" style="padding:28px 16px;">
            <h2 style="margin-top:2px; font-size: clamp(28px, 4.2vw, 52px); letter-spacing:.4px;">
              üïµÔ∏è Past Tense Mission
            </h2>
            <p style="max-width:720px; margin-top:8px;">
              <b>Sentence Detective</b> ‚Ä¢ Detect ‚Ä¢ Decide ‚Ä¢ Fix
            </p>

            <div class="row" style="margin-top:18px;">
              <input id="playerName" type="text" maxlength="28" placeholder="Enter your name" />
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="btn ghost" id="sfxBtn" style="width:min(520px,100%);">üîä SFX: ON</button>
            </div>

            <div class="row" style="margin-top:14px;">
              <button class="btn block ghost" id="practiceBtn">üß† PRACTICE</button>
              <button class="btn block primary" id="challengeBtn">‚ö° CHALLENGE</button>
            </div>

            <div class="smallNote">Premium 25 ‚Ä¢ TV-friendly ‚Ä¢ EN-only</div>
          </div>
        </section>

        <!-- GAME -->
        <section class="screen" id="gameScreen">
          <div class="questionHeader">
            <div class="qleft">
              <div class="badge"><b id="qNum">1</b>/<span id="qTotal">25</span></div>
              <div class="badge small" id="tenseTag">Past Simple</div>
              <div class="badge deep" id="deepTag" style="display:none;">‚≠ê Deep Thinking</div>
            </div>
            <div class="badge small" id="playerTag">Player: ‚Äî</div>
          </div>

          <div class="sentenceBox">
            <div class="wave" aria-hidden="true"></div>
            <div class="scan" aria-hidden="true"></div>
            <div class="sentenceInner">
              <div class="sentence" id="sentence"></div>
            </div>
          </div>

          <div class="controls">
            <button class="btn primary" id="btnCorrect">‚úÖ Correct</button>
            <button class="btn danger" id="btnIncorrect">‚ùå Incorrect</button>
            <button class="btn ghost" id="btnContinue" style="display:none;">Continue ‚ûú</button>
          </div>

          <div class="msg" id="msg">Choose Correct or Incorrect.</div>
        </section>

        <!-- END -->
        <section class="screen" id="endScreen">
          <div class="hero" style="padding:18px 14px;">
            <h2 id="finalTitle">Mission Report</h2>
            <p id="finalSummary">‚Äî</p>

            <div class="scoreBig">
              <div class="stat"><span style="opacity:.9">‚úÖ Correct</span> <b id="endPos">0</b></div>
              <div class="stat"><span style="opacity:.9">‚ö†Ô∏è Wrong</span> <b id="endNeg">0</b></div>
              <div class="stat"><span style="opacity:.9">‚≠ê Net</span> <b id="endNet">0</b></div>
            </div>
            <div id="winBannerWrap"></div>


            <div class="review" style="margin-top:14px;">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Sentence</th>
                    <th>Your Decision</th>
                    <th>Fix</th>
                    <th>Final Sentence</th>
                    <th>Type</th>
                  </tr>
                </thead>
                <tbody id="reviewBody"></tbody>
              </table>
            </div>

            <div class="footerBtns">
              <button class="btn ghost" id="restartBtn">‚Ü∫ Play Again</button>
              <button class="btn primary" id="backHomeBtn">üè† Back to Home</button>
            </div>
            <div class="smallNote">Tip: Past Simple uses V2. After <b>did/didn't</b>, use V1.</div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- HOW TO PLAY -->
  <div class="backdrop" id="howtoBackdrop" aria-hidden="true">
    <div class="popup" role="dialog" aria-modal="true">
      <div class="popupTop">
        <div class="title" id="howtoTitle">How to Play</div>
        <button class="btn ghost" id="howtoCloseBtn">Close</button>
      </div>
      <div class="popupBody">
        <div class="msg" id="howtoText" style="margin:0 0 12px; min-height:auto; text-align:left; line-height:1.55;">
          ‚Äî
        </div>
        <div class="footerBtns" style="margin-top:0;">
          <button class="btn primary" id="howtoStartBtn">START</button>
        </div>
        <div class="smallNote">Ready? Press <b>START</b>.</div>
      </div>
    </div>
  </div>

  
  <!-- REVIEW V2 (Before Play) -->
  <div class="backdrop" id="reviewBackdrop" aria-hidden="true">
    <div class="popup" role="dialog" aria-modal="true">
      <div class="popupTop">
        <div class="title">‚ö†Ô∏è Quick Review: V2 Forms in This Game</div>
        <button class="btn ghost" id="reviewCloseBtn">Close</button>
      </div>
      <div class="popupBody">
        <div class="msg" style="margin:0 0 12px; min-height:auto; text-align:left; line-height:1.55;">
          <b>Past Simple = V2</b>. Focus on <b>double consonant + -ed</b> traps.<br/>
          ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î <b>START</b> ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏à‡πâ‡∏≤ üíúüéÆ
        </div>
        <div class="review" style="margin-top:0;">
          <table>
            <thead>
              <tr>
                <th>V1</th>
                <th>V2</th>
                <th>Trap (wrong)</th>
              </tr>
            </thead>
            <tbody id="v2TableBody"></tbody>
          </table>
        </div>
        <div class="footerBtns">
          <button class="btn primary" id="reviewStartBtn">üöÄ START GAME</button>
        </div>
        <div class="smallNote">Tip: after <b>did / didn't</b> use <b>V1</b>. Past Simple uses <b>V2</b>.</div>
      </div>
    </div>
  </div>


  <!-- FIX POPUP -->
  <div class="backdrop" id="popupBackdrop" aria-hidden="true">
    <div class="popup" role="dialog" aria-modal="true">
      <div class="popupTop">
        <div class="title" id="popupTitle">Choose the correct replacement</div>
        <button class="btn ghost" id="popupCloseBtn">Close</button>
      </div>
      <div class="popupBody">
        <div class="msg" id="popupMsg" style="margin:0 0 10px; min-height:auto;">‚Äî</div>
        <div class="choices" id="choices"></div>
      </div>
    </div>
  </div>

<script>

  // ===== WOW CORE (Emoji + Confetti + Ribbon) =====
  const conf = document.getElementById("confetti");
  const cctx = conf.getContext("2d");
  let CW=0, CH=0;
  let bits = [];
  function resizeConf(){
    const dpr = window.devicePixelRatio || 1;
    CW = conf.width = window.innerWidth * dpr;
    CH = conf.height = window.innerHeight * dpr;
    conf.style.width = window.innerWidth + "px";
    conf.style.height = window.innerHeight + "px";
  }
  window.addEventListener("resize", resizeConf, {passive:true});
  resizeConf();

  function burstConfetti(x,y,count=220){
    const dpr = window.devicePixelRatio || 1;
    const px = x * dpr, py = y * dpr;
    const colors = ["#66e0ff","#b26eff","#ff4d8a","#ffffff","#a8ffea"];
    for(let i=0;i<count;i++){
      const ang = Math.random()*Math.PI*2;
      const spd = (4+Math.random()*7) * dpr;
      bits.push({
        x:px, y:py,
        vx: Math.cos(ang)*spd,
        vy: Math.sin(ang)*spd - 10*dpr,
        w: (6+Math.random()*10)*dpr,
        h: (3+Math.random()*6)*dpr,
        rot: Math.random()*Math.PI,
        vr: (Math.random()-0.5)*0.35,
        life: 120 + Math.random()*60,
        col: colors[Math.floor(Math.random()*colors.length)]
      });
    }
  }
  function confTick(){
    cctx.clearRect(0,0,CW,CH);
    bits = bits.filter(b => b.life > 0);
    for(const b of bits){
      b.life--;
      const dpr = window.devicePixelRatio || 1;
      b.vy += 0.25*dpr;
      b.x += b.vx;
      b.y += b.vy;
      b.rot += b.vr;
      cctx.save();
      cctx.translate(b.x, b.y);
      cctx.rotate(b.rot);
      cctx.globalAlpha = Math.max(0, Math.min(1, b.life/140));
      cctx.fillStyle = b.col;
      cctx.fillRect(-b.w/2, -b.h/2, b.w, b.h);
      cctx.restore();
    }
    requestAnimationFrame(confTick);
  }
  confTick();

  const emojiLayer = document.getElementById("emojiBurst");
  const GOOD_EMOJI = ["üëç","üòé","ü•≥","üî•","‚ú®","üéØ","‚úÖ","üèÜ"];
  const BAD_EMOJI  = ["üò†","üò§","üòñ","üôÉ","üòµ‚Äçüí´","üò¨","ü§Ø","üòú"];
  function randomFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function popEmoji(emoji, x, y){
    if(!emojiLayer) return;
    const el = document.createElement("div");
    el.className = "emojiPop";
    el.textContent = emoji;
    el.style.left = x + "px";
    el.style.top  = y + "px";
    emojiLayer.appendChild(el);
    setTimeout(()=>el.remove(), 900);
  }

  function centerEmojiBlast(kind="good"){
    if(!emojiLayer) return;
    emojiLayer.innerHTML = "";
    const big = document.createElement("div");
    big.className = "emojiMega";
    big.textContent = kind==="good" ? randomFrom(GOOD_EMOJI) : randomFrom(BAD_EMOJI);
    emojiLayer.appendChild(big);

    setTimeout(()=>popEmoji(randomFrom(kind==="good"?GOOD_EMOJI:BAD_EMOJI),
      window.innerWidth*0.5 + 140, window.innerHeight*0.5), 120);
    setTimeout(()=>popEmoji(randomFrom(kind==="good"?GOOD_EMOJI:BAD_EMOJI),
      window.innerWidth*0.5 - 140, window.innerHeight*0.5), 180);
  }

  function ribbonRain(count=30){
    const layer = document.getElementById("ribbonLayer");
    if(!layer) return;
    for(let i=0;i<count;i++){
      const r = document.createElement("div");
      r.className = "ribbon";
      r.style.left = Math.random()*100 + "vw";
      r.style.background = ["#66e0ff","#b26eff","#ff4d8a","#ffffff","#00ff9c"][Math.floor(Math.random()*5)];
      r.style.animationDuration = (1.2+Math.random()*0.8)+"s";
      layer.appendChild(r);
      setTimeout(()=>r.remove(),1800);
    }
  }

  function celebrate(kind="good"){
    const x = window.innerWidth*0.5;
    const y = window.innerHeight*0.20;
    if(kind==="good"){
      burstConfetti(x, y, 240);
      ribbonRain(28);
      centerEmojiBlast("good");
    }else{
      centerEmojiBlast("bad");
    }
  }


(() => {
  const QUESTIONS = [
  {
    "id": 1,
    "type": "standard",
    "words": [
      "I",
      "visited",
      "my",
      "grandma",
      "yesterday."
    ],
    "isCorrect": true
  },
  {
    "id": 2,
    "type": "standard",
    "words": [
      "She",
      "go",
      "to",
      "school",
      "last",
      "Monday."
    ],
    "isCorrect": false,
    "wrongIndex": 1,
    "correct": "went",
    "options": [
      "went",
      "gone",
      "goed",
      "go"
    ]
  },
  {
    "id": 3,
    "type": "standard",
    "words": [
      "They",
      "played",
      "football",
      "after",
      "school",
      "yesterday."
    ],
    "isCorrect": true
  },
  {
    "id": 4,
    "type": "standard",
    "words": [
      "He",
      "buyed",
      "a",
      "new",
      "bag",
      "yesterday."
    ],
    "isCorrect": false,
    "wrongIndex": 1,
    "correct": "bought",
    "options": [
      "bought",
      "brought",
      "buyed",
      "buy"
    ]
  },
  {
    "id": 5,
    "type": "standard",
    "words": [
      "We",
      "watched",
      "a",
      "movie",
      "last",
      "night."
    ],
    "isCorrect": true
  },
  {
    "id": 6,
    "type": "standard",
    "words": [
      "The",
      "baby",
      "cried",
      "all",
      "night."
    ],
    "isCorrect": true
  },
  {
    "id": 7,
    "type": "standard",
    "words": [
      "Tom",
      "eated",
      "noodles",
      "yesterday."
    ],
    "isCorrect": false,
    "wrongIndex": 1,
    "correct": "ate",
    "options": [
      "ate",
      "eaten",
      "eated",
      "eat"
    ]
  },
  {
    "id": 8,
    "type": "standard",
    "words": [
      "I",
      "didn't",
      "went",
      "to",
      "the",
      "party",
      "last",
      "night."
    ],
    "isCorrect": false,
    "wrongIndex": 2,
    "correct": "go",
    "options": [
      "go",
      "went",
      "gone",
      "goed"
    ]
  },
  {
    "id": 9,
    "type": "standard",
    "words": [
      "Did",
      "you",
      "watched",
      "TV",
      "yesterday?"
    ],
    "isCorrect": false,
    "wrongIndex": 2,
    "correct": "watch",
    "options": [
      "watch",
      "watched",
      "watching",
      "watcht"
    ]
  },
  {
    "id": 10,
    "type": "standard",
    "words": [
      "She",
      "didn't",
      "play",
      "games",
      "yesterday."
    ],
    "isCorrect": true
  },
  {
    "id": 11,
    "type": "standard",
    "words": [
      "We",
      "did",
      "our",
      "homework",
      "last",
      "night."
    ],
    "isCorrect": true
  },
  {
    "id": 12,
    "type": "standard",
    "words": [
      "He",
      "was",
      "at",
      "home",
      "yesterday."
    ],
    "isCorrect": true
  },
  {
    "id": 13,
    "type": "standard",
    "words": [
      "They",
      "was",
      "happy",
      "yesterday."
    ],
    "isCorrect": false,
    "wrongIndex": 1,
    "correct": "were",
    "options": [
      "were",
      "was",
      "ware",
      "wore"
    ]
  },
  {
    "id": 14,
    "type": "standard",
    "words": [
      "Did",
      "he",
      "see",
      "the",
      "doctor",
      "yesterday?"
    ],
    "isCorrect": true
  },
  {
    "id": 15,
    "type": "standard",
    "words": [
      "I",
      "saw",
      "him",
      "two",
      "days",
      "ago."
    ],
    "isCorrect": true
  },
  {
    "id": 16,
    "type": "standard",
    "words": [
      "She",
      "wrote",
      "a",
      "letter",
      "last",
      "week."
    ],
    "isCorrect": true
  },
  {
    "id": 17,
    "type": "standard",
    "words": [
      "He",
      "write",
      "a",
      "letter",
      "last",
      "week."
    ],
    "isCorrect": false,
    "wrongIndex": 1,
    "correct": "wrote",
    "options": [
      "wrote",
      "written",
      "writed",
      "write"
    ]
  },
  {
    "id": 18,
    "type": "standard",
    "words": [
      "We",
      "stopped",
      "the",
      "car",
      "suddenly."
    ],
    "isCorrect": true
  },
  {
    "id": 19,
    "type": "standard",
    "words": [
      "They",
      "stoped",
      "the",
      "car",
      "yesterday."
    ],
    "isCorrect": false,
    "wrongIndex": 1,
    "correct": "stopped",
    "options": [
      "stopped",
      "stoped",
      "stopt",
      "stopping"
    ]
  },
  {
    "id": 20,
    "type": "standard",
    "words": [
      "Did",
      "they",
      "ate",
      "yet?"
    ],
    "isCorrect": false,
    "wrongIndex": 2,
    "correct": "eat",
    "options": [
      "eat",
      "eaten",
      "eated"
    ]
  },
  {
    "id": 21,
    "type": "deep",
    "words": [
      "She",
      "didn't",
      "went",
      "to",
      "work",
      "yesterday."
    ],
    "isCorrect": false,
    "highlights": [
      2
    ],
    "fixIndex": 2,
    "correct": "go",
    "options": [
      "go",
      "went",
      "gone",
      "goed"
    ],
    "noteWrongFix": "After <b>didn't</b>, use the base verb (V1): <b>go</b>."
  },
  {
    "id": 22,
    "type": "deep",
    "words": [
      "Did",
      "you",
      "played",
      "basketball",
      "yesterday?"
    ],
    "isCorrect": false,
    "highlights": [
      2
    ],
    "fixIndex": 2,
    "correct": "play",
    "options": [
      "play",
      "played",
      "playd",
      "playing"
    ],
    "noteWrongFix": "After <b>Did</b>, use the base verb (V1): <b>play</b>."
  },
  {
    "id": 23,
    "type": "deep",
    "words": [
      "He",
      "go",
      "to",
      "school",
      "yesterday."
    ],
    "isCorrect": false,
    "highlights": [
      1
    ],
    "fixIndex": 1,
    "correct": "went",
    "options": [
      "went",
      "gone",
      "goed"
    ],
    "noteWrongFix": "Past Simple needs V2 with <b>yesterday</b>: go ‚Üí <b>went</b>."
  },
  {
    "id": 24,
    "type": "deep",
    "words": [
      "They",
      "watch",
      "TV",
      "last",
      "night."
    ],
    "isCorrect": false,
    "highlights": [
      1
    ],
    "fixIndex": 1,
    "correct": "watched",
    "options": [
      "watched",
      "watch",
      "watcht"
    ],
    "noteWrongFix": "If you use <b>were</b> + verb, it needs <b>-ing</b>."
  },
  {
    "id": 25,
    "type": "deep",
    "words": [
      "I",
      "forget",
      "my",
      "keys",
      "yesterday."
    ],
    "isCorrect": false,
    "highlights": [
      1
    ],
    "fixIndex": 1,
    "correct": "forgot",
    "options": [
      "forgot",
      "forgotten",
      "forgetted",
      "forget"
    ],
    "noteWrongFix": "Past Simple needs V2: forget ‚Üí <b>forgot</b>."
  }
];

  // ---------- SFX ----------
  let sfxOn = true;
  let ac = null;
  function ensureAC(){
    if(!ac) ac = new (window.AudioContext || window.webkitAudioContext)();
    if(ac.state === "suspended") ac.resume();
  }
  function beep(kind="click"){
    if(!sfxOn) return;
    try{
      ensureAC();
      const o = ac.createOscillator();
      const g = ac.createGain();
      const now = ac.currentTime;
      o.type = (kind==="bad") ? "sawtooth" : "sine";
      let f=520, dur=0.06, gain=0.06;
      if(kind==="good"){ f=860; dur=0.12; gain=0.08; }
      if(kind==="bad"){ f=180; dur=0.14; gain=0.06; }
      g.gain.setValueAtTime(0, now);
      g.gain.linearRampToValueAtTime(gain, now+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
      o.frequency.setValueAtTime(f, now);
      o.connect(g); g.connect(ac.destination);
      o.start(now); o.stop(now+dur+0.02);
    }catch(e){}
  }

  // ---------- Helpers ----------
  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  }
  function escapeHTML(str){
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
  function currentText(words){
    return words.join(" ").replace(/\s+([?.!,])/g, "$1");
  }

  // ---------- State ----------
  let player="Player", mode="practice";
  let deck=[], idx=0;
  let pos=0, neg=0;
  let decisionOK=0, decisionNO=0, fixOK=0, fixNO=0, timeouts=0;
  let current=null, phase="decide";
  let timer=null, timeLeft=20, allowContinue=false;
  const logs=[];

  // ---------- DOM ----------
  const startScreen = document.getElementById("startScreen");
  const gameScreen  = document.getElementById("gameScreen");
  const endScreen   = document.getElementById("endScreen");
  const playerName  = document.getElementById("playerName");
  const practiceBtn = document.getElementById("practiceBtn");
  const challengeBtn= document.getElementById("challengeBtn");
  const sfxBtn = document.getElementById("sfxBtn");

  const posScoreEl = document.getElementById("posScore");
  const negScoreEl = document.getElementById("negScore");
  const netScoreEl = document.getElementById("netScore");
  const modeTagEl  = document.getElementById("modeTag");

  const timerBox   = document.getElementById("timerBox");
  const timeLeftEl = document.getElementById("timeLeft");

  const qNumEl     = document.getElementById("qNum");
  const qTotalEl   = document.getElementById("qTotal");
  const playerTag  = document.getElementById("playerTag");
  const deepTag    = document.getElementById("deepTag");
  const sentenceEl = document.getElementById("sentence");

  const msgEl      = document.getElementById("msg");
  const btnCorrect = document.getElementById("btnCorrect");
  const btnIncorrect= document.getElementById("btnIncorrect");
  const btnContinue= document.getElementById("btnContinue");

  const popupBackdrop = document.getElementById("popupBackdrop");
  const popupTitle = document.getElementById("popupTitle");
  const popupMsg   = document.getElementById("popupMsg");
  const choicesEl  = document.getElementById("choices");
  const popupCloseBtn = document.getElementById("popupCloseBtn");

  const howtoBackdrop = document.getElementById("howtoBackdrop");
  const howtoTitle = document.getElementById("howtoTitle");
  const howtoText = document.getElementById("howtoText");
  const howtoCloseBtn = document.getElementById("howtoCloseBtn");
  const howtoStartBtn = document.getElementById("howtoStartBtn");
  let pendingMode=null;


  // ===== REVIEW V2 LIST (set 2) =====
  const reviewBackdrop = document.getElementById("reviewBackdrop");
  const reviewCloseBtn = document.getElementById("reviewCloseBtn");
  const reviewStartBtn = document.getElementById("reviewStartBtn");
  const v2TableBody = document.getElementById("v2TableBody");

  function buildV2Table(){
    if(!v2TableBody) return;
    const rows = [
      ["stop","stopped","stoped"],
      ["plan","planned","planed"],
      ["drop","dropped","droped"],
      ["shop","shopped","shoped"],
      ["nod","nodded","noded"],
      ["slip","slipped","sliped"],
      ["clap","clapped","claped"],
      ["wrap","wrapped","wraped"],
      ["rip","ripped","riped"],
      ["cancel","cancelled","canceled"]
    ];
    v2TableBody.innerHTML = "";
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td><b>${r[0]}</b></td><td><b>${r[1]}</b></td><td style="color:var(--bad)"><b>${r[2]}</b></td>`;
      v2TableBody.appendChild(tr);
    });
  }

  function openReview(){
    buildV2Table();
    reviewBackdrop.classList.add("show");
  }
  function closeReview(){
    reviewBackdrop.classList.remove("show");
  }


  const finalTitle = document.getElementById("finalTitle");
  const finalSummary = document.getElementById("finalSummary");
  const reviewBody = document.getElementById("reviewBody");
  const restartBtn = document.getElementById("restartBtn");
  const backHomeBtn= document.getElementById("backHomeBtn");

  // ---------- UI helpers ----------
  function show(screen){
    [startScreen, gameScreen, endScreen].forEach(s=>s.classList.remove("active"));
    screen.classList.add("active");
  }
  function updateScores(){
    posScoreEl.textContent = String(pos);
    negScoreEl.textContent = String(neg);
    netScoreEl.textContent = String(pos - neg);
  }
  function setMsg(html){ msgEl.innerHTML = html; }
  function setContinue(on){ btnContinue.style.display = on ? "inline-flex" : "none"; allowContinue = on; }

  function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }
  function startTimer(){
    stopTimer();
    if(mode!=="challenge") return;
    timeLeft=20;
    timeLeftEl.textContent=String(timeLeft);
    timerBox.style.borderColor="rgba(255,255,255,.14)";
    timer=setInterval(()=>{
      timeLeft--;
      timeLeftEl.textContent=String(Math.max(0,timeLeft));
      timerBox.style.borderColor = (timeLeft<=5) ? "rgba(255,77,109,.75)" : "rgba(255,255,255,.14)";
      if(timeLeft<=0){ stopTimer(); onTimeout(); }
    }, 1000);
  }

  function makeSentenceHTML(words, hlSet = new Set(), selectable=false){
    sentenceEl.innerHTML="";
    words.forEach((w,i)=>{
      const span=document.createElement("span");
      span.className="word" + (selectable ? " selectable" : "") + (hlSet.has(i) ? " hl" : "");
      span.textContent=w;
      span.dataset.idx=String(i);
      sentenceEl.appendChild(span);
    });
  }

  function openPopup(title, msg, options, onPick){
    popupTitle.textContent=title;
    popupMsg.innerHTML=msg;
    choicesEl.innerHTML="";
    options.forEach(opt=>{
      const div=document.createElement("div");
      div.className="choice";
      div.textContent=opt;
      div.addEventListener("click", ()=>onPick(opt), {passive:true});
      choicesEl.appendChild(div);
    });
    popupBackdrop.classList.add("show");
  }
  function closePopup(){ popupBackdrop.classList.remove("show"); }

  function openHowTo(selectedMode){
    pendingMode=selectedMode;
    const isChallenge = selectedMode==="challenge";
    howtoTitle.textContent = isChallenge ? "How to Play: CHALLENGE" : "How to Play: PRACTICE";
    const items=[];
    items.push("<li><b>Goal:</b> Fix Past Simple mistakes (V2), and traps with <b>V2 vs V3</b> / <b>-ed</b>.</li>");
    items.push("<li>Includes <b>affirmative</b>, <b>negative</b>, and <b>questions</b>.</li>");
    items.push("<li>Click <b>Correct</b> or <b>Incorrect</b>.</li>");
    items.push("<li>If <b>Incorrect</b>, click the <b>highlighted word</b> to open the popup and fix it.</li>");
    items.push("<li>Important rule: after <b>did / didn't</b>, use <b>V1</b>.</li>");
    if(isChallenge) items.push("<li>‚è≥ 20 seconds per question. Timeout = <b>‚àí1</b>.</li>");
    else items.push("<li>No timer. Take your time.</li>");
    items.push("<li>Scoring: correct = <b>+1</b>, wrong = <b>‚àí1</b>.</li>");
    howtoText.innerHTML = "<ul class='howtoList' style='margin:0;padding-left:18px;line-height:1.6;font-size:clamp(14px,2vw,18px)'>" + items.join("") + "</ul>";
    howtoBackdrop.classList.add("show");
  }
  function closeHowTo(){ howtoBackdrop.classList.remove("show"); }

  function begin(selectedMode){
    ensureAC();
    mode=selectedMode;
    player=(playerName.value||"Player").trim().slice(0,28)||"Player";
    modeTagEl.textContent = mode==="challenge" ? "Mode: Challenge (20s)" : "Mode: Practice";
    timerBox.classList.toggle("show", mode==="challenge");
    playerTag.textContent = "Player: " + player;

    pos=0; neg=0; decisionOK=0; decisionNO=0; fixOK=0; fixNO=0; timeouts=0;
    logs.length=0; updateScores();

    const standard = shuffle(QUESTIONS.filter(q=>q.type==="standard"));
    const deep = shuffle(QUESTIONS.filter(q=>q.type==="deep"));
    deck=[];
    let si=0, di=0;
    while(si<standard.length || di<deep.length){
      for(let k=0;k<3 && si<standard.length;k++) deck.push(standard[si++]);
      if(di<deep.length) deck.push(deep[di++]);
    }
    deck = deck.slice(0,25);
    idx=0;
    qTotalEl.textContent=String(deck.length);
    show(gameScreen);
    loadQuestion();
  }

  function loadQuestion(){
    stopTimer();
    setContinue(false);
    phase="decide";
    current = JSON.parse(JSON.stringify(deck[idx]));
    current.user={decision:null,fixed:false,fixCorrect:null,timeout:false};
    current.originalWords = current.words.slice();

    qNumEl.textContent=String(idx+1);
    deepTag.style.display = (current.type==="deep") ? "inline-flex" : "none";

    makeSentenceHTML(current.words, new Set(), false);
    setMsg("Choose <b>Correct</b> or <b>Incorrect</b>.");
    btnCorrect.disabled=false;
    btnIncorrect.disabled=false;
    startTimer();
  }

  function onTimeout(){
    timeouts++;
    current.user.timeout=true;
    current.user.decision="timeout";
    decisionNO++;
    neg++; updateScores();
    btnCorrect.disabled=true; btnIncorrect.disabled=true;
    setMsg("‚è±Ô∏è Time's up! That counts as <b>‚àí1</b>. Click Continue.");
    beep("bad");
    setContinue(true);
  }

  function finishQuestion(){
    stopTimer();
    logs.push({
      sentence: currentText(current.originalWords),
      decision: current.user.decision,
      fix: current.user.fixed ? (current.user.fixCorrect ? "Correct Fix" : "Wrong Fix") : (current.user.decision==="incorrect" && !current.isCorrect ? "No Fix" : "‚Äî"),
      finalSentence: currentText(current.words),
      type: current.type==="deep" ? "Deep ‚≠ê" : "Standard"
    });
    idx++;
    if(idx>=deck.length) endGame();
    else loadQuestion();
  }

  function endGame(){
    stopTimer();
    show(endScreen);
    const net = pos - neg;
    const emoji = net >= 18 ? "üèÜ" : net >= 12 ? "üåü" : net >= 6 ? "üôÇ" : "üí™";
    finalTitle.textContent = `${emoji} Mission Report: ${player}`;
    finalSummary.innerHTML = `Net score: <b>${net}</b> ( +${pos} / ‚àí${neg} ) ‚Ä¢ Premium Past Tense set`;

    
    document.getElementById("endPos").textContent = String(pos);
    document.getElementById("endNeg").textContent = String(neg);
    document.getElementById("endNet").textContent = String(net);

    const wrap = document.getElementById("winBannerWrap");
    wrap.innerHTML = "";
    const pass = net >= 12; // WIN threshold (adjust anytime)
    const banner = document.createElement("div");
    banner.className = "winBanner";
    if(pass){
      banner.innerHTML = "üèÜ <span>YOU WIN!</span> <span style='opacity:.85'>(Past Tense Master)</span>";
      wrap.appendChild(banner);
      // one big celebration
      celebrate("good");
      setTimeout(()=>celebrate("good"), 350);
    }else{
      banner.style.animation = "none";
      banner.style.borderColor = "rgba(255,77,109,.55)";
      banner.style.background = "linear-gradient(180deg, rgba(255,77,109,.18), rgba(0,0,0,.22))";
      banner.innerHTML = "üí™ <span>KEEP TRYING!</span> <span style='opacity:.85'>(Play Again)</span>";
      wrap.appendChild(banner);
      celebrate("bad");
    }



    reviewBody.innerHTML="";
    logs.forEach((l,i)=>{
      const decisionPill =
        l.decision==="timeout" ? `<span class="pill mid">‚è± Timeout</span>` :
        l.decision==="correct" ? `<span class="pill ok">‚úÖ Correct</span>` :
        `<span class="pill no">‚ùå Incorrect</span>`;
      const fixPill =
        l.fix==="Correct Fix" ? `<span class="pill ok">üõ† Correct</span>` :
        l.fix==="Wrong Fix" ? `<span class="pill no">üß© Wrong</span>` :
        `<span class="pill mid">‚Äî</span>`;
      const typePill = l.type==="Deep ‚≠ê" ? `<span class="pill mid">Deep ‚≠ê</span>` : `<span class="pill mid">Standard</span>`;
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td><b>${i+1}</b></td>
        <td>${escapeHTML(l.sentence)}</td>
        <td>${decisionPill}</td>
        <td>${fixPill}</td>
        <td>${escapeHTML(l.finalSentence)}</td>
        <td>${typePill}</td>
      `;
      reviewBody.appendChild(tr);
    });
  }

  function pickChoices(options, correct, n=3){
    const uniq = Array.from(new Set(options));
    const wrongs = uniq.filter(o=>o!==correct);
    const picks=[correct];
    while(picks.length<n && wrongs.length){
      const i=Math.floor(Math.random()*wrongs.length);
      picks.push(wrongs.splice(i,1)[0]);
    }
    for(let i=picks.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [picks[i],picks[j]]=[picks[j],picks[i]]; }
    return picks;
  }

  function openFixPopup(q, wi){
    phase="popup";
    const originalWord = q.words[wi];
    const opts = pickChoices((q.options||[]).slice(), q.correct, 3);
    openPopup("Choose the correct replacement", `Replace <b>${escapeHTML(originalWord)}</b> with:`, opts, (picked)=>{
      const ok = picked===q.correct;
      if(ok){
        q.words[wi]=q.correct;
        q.user.fixed=true;
        q.user.fixCorrect=true;
        fixOK++; pos++; updateScores();
        closePopup();
        makeSentenceHTML(q.words, new Set(), false);
        setMsg("‚úÖ Correct fix! +1 üéâ Click Continue.");
        beep("good");
        celebrate("good");
        setContinue(true);
        phase="done";
      }else{
        q.user.fixed=true;
        q.user.fixCorrect=false;
        fixNO++; neg++; updateScores();
        closePopup();
        phase="pickfix";
        const hl = (q.type==="standard") ? new Set([q.wrongIndex]) : new Set(q.highlights);
        makeSentenceHTML(q.words, hl, true);
        setMsg("‚ùå Not quite. (<b>‚àí1</b>) Try again.");
        beep("bad");
        celebrate("bad");
        setContinue(false);
      }
    });
  }

  function handleDecision(dec){
    if(phase!=="decide") return;
    current.user.decision=dec;
    const decisionIsCorrect = (dec==="correct" && current.isCorrect) || (dec==="incorrect" && !current.isCorrect);
    if(decisionIsCorrect){ decisionOK++; pos++; updateScores(); beep("good"); celebrate("good"); }
    else{ decisionNO++; neg++; updateScores(); beep("bad"); celebrate("bad"); }

    if(current.isCorrect){
      btnCorrect.disabled=true; btnIncorrect.disabled=true;
      setMsg(`üôÇ This sentence is <b>correct</b>. Click Continue.`);
      setContinue(true);
      return;
    }
    if(dec==="correct"){ // wrong call
      btnCorrect.disabled=true; btnIncorrect.disabled=true;
      setMsg(`üôÉ This sentence is <b>incorrect</b>. Click Continue.`);
      setContinue(true);
      return;
    }

    // Incorrect decision is correct -> fix phase
    phase="pickfix";
    stopTimer(); // pause while fixing
    const hl = (current.type==="standard") ? new Set([current.wrongIndex]) : new Set(current.highlights);
    makeSentenceHTML(current.words, hl, true);
    setMsg(current.type==="deep"
      ? `‚≠ê Deep Thinking: Click the <b>highlighted word</b> to fix.<br/>${current.noteWrongFix||""}`
      : "üõ† Click the <b>highlighted word</b> to fix the sentence."
    );
    btnCorrect.disabled=true; btnIncorrect.disabled=true;
    setContinue(false);
  }

  // ---------- Events ----------
  if(sfxBtn){
    sfxBtn.addEventListener("click", ()=>{
      sfxOn=!sfxOn;
      sfxBtn.textContent = sfxOn ? "üîä SFX: ON" : "üîá SFX: OFF";
      beep("click");
    });
  }

  btnCorrect.addEventListener("click", ()=>handleDecision("correct"));
  btnIncorrect.addEventListener("click", ()=>handleDecision("incorrect"));
  btnContinue.addEventListener("click", ()=>{ if(allowContinue) finishQuestion(); });

  sentenceEl.addEventListener("click", (e)=>{
    const t = e.target;
    if(!(t instanceof HTMLElement)) return;
    const w = t.closest(".word.selectable");
    if(!w) return;
    if(phase!=="pickfix") return;

    const wi = Number(w.dataset.idx);
    if(Number.isNaN(wi)) return;

    if(current.type==="standard"){
      if(wi !== current.wrongIndex){
        fixNO++; neg++; updateScores();
        setMsg("‚ùå Not that word. Fix the highlighted word. (<b>‚àí1</b>) Try again.");
        celebrate("bad");
        return;
      }
      openFixPopup(current, wi);
      return;
    }

    // deep (single highlight by design)
    if(!current.highlights.includes(wi)) return;
    if(wi !== current.fixIndex){
      fixNO++; neg++; updateScores();
      setMsg(`‚ö†Ô∏è Not the best fix point. (<b>‚àí1</b>)<br/>${current.noteWrongFix||""}`);
      beep("bad");
      return;
    }
    openFixPopup(current, wi);
  });

  popupCloseBtn.addEventListener("click", ()=>{
    closePopup();
    if(phase==="popup") {
      phase="pickfix";
      const hl = (current.type==="standard") ? new Set([current.wrongIndex]) : new Set(current.highlights);
      makeSentenceHTML(current.words, hl, true);
      setMsg("Pick the highlighted word, then choose the correct replacement.");
    }
  });
  popupBackdrop.addEventListener("click", (e)=>{ if(e.target===popupBackdrop) popupCloseBtn.click(); });

  howtoCloseBtn.addEventListener("click", ()=>{ beep("click"); closeHowTo(); });
  howtoStartBtn.addEventListener("click", ()=>{
    beep("click");
    const m = pendingMode || "practice";
    closeHowTo();
    begin(m);
  });
  howtoBackdrop.addEventListener("click", (e)=>{ if(e.target===howtoBackdrop) howtoCloseBtn.click(); });


  reviewCloseBtn.addEventListener("click", ()=>{ beep("click"); closeReview(); });
  reviewBackdrop.addEventListener("click", (e)=>{ if(e.target===reviewBackdrop) reviewCloseBtn.click(); });
  reviewStartBtn.addEventListener("click", ()=>{ beep("click"); closeReview(); openHowTo(pendingMode||"practice"); });


  practiceBtn.addEventListener("click", ()=>{ pendingMode="practice"; openReview(); });
challengeBtn.addEventListener("click", ()=>{ pendingMode="challenge"; openReview(); });
restartBtn.addEventListener("click", ()=>begin(mode));
  backHomeBtn.addEventListener("click", ()=>{ stopTimer(); show(startScreen); modeTagEl.textContent="Mode: ‚Äî"; timerBox.classList.remove("show"); });
})();

  // ===== CENTER MEGA EMOJI BLAST (v5) =====
  function centerEmojiBlast(kind="good"){
    if(!emojiLayer) return;
    emojiLayer.innerHTML = "";
    const big = document.createElement("div");
    big.className = "emojiMega";
    big.textContent = kind==="good" ? randomFrom(GOOD_EMOJI) : randomFrom(BAD_EMOJI);
    emojiLayer.appendChild(big);

    // side accents
    setTimeout(()=>popEmoji(randomFrom(kind==="good"?GOOD_EMOJI:BAD_EMOJI),
      window.innerWidth*0.5 + 140, window.innerHeight*0.5), 120);
    setTimeout(()=>popEmoji(randomFrom(kind==="good"?GOOD_EMOJI:BAD_EMOJI),
      window.innerWidth*0.5 - 140, window.innerHeight*0.5), 180);
  }


  // ===== RIBBON CONFETTI =====
  
  function ribbonRain(count=30){
    const layer = document.getElementById("ribbonLayer");
    if(!layer) return;
    for(let i=0;i<count;i++){
      const r = document.createElement("div");
      r.className = "ribbon";
      r.style.left = Math.random()*100 + "vw";
      r.style.background = ["#66e0ff","#b26eff","#ff4d8a","#ffffff","#00ff9c"][Math.floor(Math.random()*5)];
      r.style.animationDuration = (1.2+Math.random()*0.8)+"s";
      layer.appendChild(r);
      setTimeout(()=>r.remove(),1800);
    }
  }

</script>
</body>
</html>
